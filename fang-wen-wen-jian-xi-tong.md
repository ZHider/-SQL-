# 访问文件系统

在本节中，我将介绍如何利用 SQL 注入获取后端 DBMS 底层文件系统的读写权限。 根据配置的不同，这种方法可能非常复杂，而且可能需要注意数据库管理系统架构和网络应用程序施加的限制。

## 读取权限

在渗透测试期间，对被入侵机器上文件的读取权限可能非常有用：它可能导致信息泄露，帮助攻击者实施进一步攻击，因为它可能导致敏感用户的信息泄露。

### MySQL

MySQL 有一个内置函数，允许读取底层文件系统上的文本或二进制文件：`LOAD_FILE()`。会话用户必须拥有以下权限：`FILE` 和 `CREATE TABLE` 权限（仅在堆叠查询时需要）。在 Linux 和 UNIX 系统上，文件必须由启动 MySQL 进程的用户（通常是 `mysql`）拥有，或者该文件所有用户都可读。在 Windows 系统中，MySQL 默认以本地系统身份运行，因此可以通过数据库管理系统读取任何现有文件。

可以通过 UNION 查询、盲注或基于错误的 SQL 注入技术检索文件内容。不过，在调用 `LOAD_FILE()` 函数时需要考虑一些限制：

* 如果添加文件内容的列数据类型为 varchar，则显示的文件字符最大长度为 5000；
* 通过基于错误的 SQL 注入技术检索文件时，文件内容在很多情况下会被截断为几个字符；
* 文件可以是二进制格式（如 Linux 上的 ELF 或 Windows 上的可执行文件），而且根据网络应用程序语言的不同，无法通过 UNION 查询或基于错误的 SQL 注入技术在页面内容中显示。

绕过这些限制的步骤：

* 通过分批查询：
  * 创建一个有一个字段、数据类型为 `longtext` 的临时表；
  * 使用 `LOAD_FILE()` 函数读取文件内容，并通过 `INTO DUMPFILE` 将相应的十六进制编码字符串值重定向到临时文件中；
  * 使用 `LOAD DATA INFILE` 将临时文件内容加载到临时表中。
* 通过其他 SQL 注入技术：
  * 读取临时表字段值的长度；
  * 以 1024 个字符为单位转储临时表的字段值。

现在需要将这些字符串组合成一个十六进制编码字符串，然后解码并写入本地文件。

### PostgreSQL

PostgreSQL 有一个内置语句，允许将文本文件从底层文件系统复制到表的文本字段：`COPY`。

1. 会话用户必须是 “超级用户”才能调用该语句。
2. &#x20;文件必须归启动 PostgreSQL 进程的用户（通常是 `postgres`）所有，或者是全部用户可读的。

可以通过 UNION 查询、盲注或基于错误的 SQL 注入技术检索文件内容。不过，网络应用程序编程语言必须支持分批查询。 具体步骤如下

* 通过分批查询：
  * 创建一个有一个字段、数据类型为 `bytea` 的临时表；
  * 使用 `COPY` 语句将文本文件的内容加载到临时表中。
* 通过任何其他 SQL 注入技术：
  * 计算支持表中的条目数；
  * 通过 `ENCODE` 函数将支持表的字段条目转为 base64 编码。

现在，需要将转储的条目组装成一个 base64 编码字符串，然后将其解码并写入本地文件。

自 PostgreSQL 7.4 起，`COPY` 语句就不能用来读取二进制文件了：不过可以用一个自定义的用户定义函数来读取二进制文件。这个用户自定义函数输入二进制文件，并将其内容以十六进制编码字符串的形式输出到临时文本文件中。然后，攻击者就可以如上所述读取该文本文件。

### Microsoft SQL Server

Microsoft SQL Server 有一个内置语句，允许将文件系统中的文本或二进制文件内容插入到表的 `VARCHAR` 字段中：`BULK INSERT`。

会话用户必须具有以下权限： `INSERT`、`ADMINISTER BULK OPERATIONS` 和 `CREATE TABLE`。

&#x20;Microsoft SQL Server 2000 默认以管理员身份运行，因此数据库管理系统可以读取任何现有文件。如果数据库管理员将 Microsoft SQL Server 2005 和 2008 配置为以本地系统 (`SYSTEM`) 或管理员身份运行，则情况也一样，否则文件必须是所有用户可读的，而这在 Windows 上很普遍。

可以通过 UNION 查询、盲注或基于错误的 SQL 注入技术检索文件内容。不过，网络应用程序编程语言必须支持批量查询。

步骤如下：

* 通过堆叠查询：
  * 创建一个临时表(表1) ，其中包含一个字段，数据类型为 `text`；
  * 创建另一个临时表(表2) ，其中包含两个字段，一个是数据类型 `INT IDENTITY (1,1) PRIMARY KEY`，另一个是数据类型 `VARCHAR (4096)` ;&#x20;
  * 使用 `BULK INSERT` 语句将文件内容作为一个条目载入表1；
  * Inject SQL code to convert the support table table1 entry into its hexadecimal encoded value then INSERT 4096 characters of the encoded string into each entry of the support table table2.&#x20;
