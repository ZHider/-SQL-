# 介绍

SQL 注入攻击并不新鲜。千禧年以前，Jeorristal Phrack 就描述了这种攻击背后的基本概念。 在 OWASP Top 10 中的 The Open Web Application Security Project 指出：注入攻击，尤其是 SQL 注入，是最常见、最危险的网络应用漏洞，仅次于跨站脚本攻击。 现在的问题是：攻击者利用 SQL 注入能达到什么程度？本文将探讨这个问题。

## SQL 注入

OWASP 指南对 SQL 注入的定义如下：

> SQL 注入攻击包括通过从客户端到应用程序的输入数据插入或 "注入 "一个 SQL 查询。 注入 "SQL 查询。成功的 SQL 注入攻击可读取数据库中的敏感数据、修改数据库数据（插入/更新/删除）、执行数据库管理操作（如关闭数据库管理系统）、恢复数据库管理系统中给定数据库的内容，有时还可向操作系统发出命令。SQL 注入攻击是注入攻击的一种，在这种攻击中，SQL 命令被注入到数据平面输入中，以便执行预先设定的 SQL 命令。

虽然这是网络应用程序的常见问题，但实际上，任何通过结构化查询语言与数据库管理系统通信的应用程序都可能存在这种漏洞。&#x20;

SQL 注入是指应用程序未能对 SQL 查询中使用的用户输入内容进行适当的转义（sanitize user-input）。这样，攻击者就可以操纵传递给后端数据库管理系统的 SQL 语句，而该语句将以与执行查询的应用程序相同的权限运行。从现在起，我将把这个用户称为当前会话用户（session user）。

现代数据库管理系统是功能强大的应用程序。它们通常提供与底层文件系统交互的内置工具，在某些情况下还提供与操作系统交互的内置工具。然而，当这些工具不存在时，恶意的攻击者仍然可以访问文件系统，并在底层系统上执行任意命令：本文将以基于网络的应用程序为重点，介绍如何通过 SQL 注入漏洞实现这一目标。

## Web 应用程序脚本语言

有许多网络应用动态脚本语言：其中最常用的有 PHP 、ASP 和 ASP.NET。从网络开发人员或渗透测试人员的角度来看，所有这些语言都各有利弊。它们还具有内置或第三方连接器，可通过 SQL 与数据库管理系统交互。 绝大多数网络应用程序都是通过 SQL 语句。

* 在 PHP 上，我使用本地函数来连接和查询 DBMS。
* 在 ASP 上，我使用了第三方连接器： 用于 MySQL 的 MySQL Connector/ODBC 5.1 和用于 PostgreSQL 的 PostgreSQL ANSI 驱动程序。&#x20;
* 在 ASP.NET 上，我也使用了第三方连接器： Connector/Net 5.2.5 for 和 PostgreSQL 的 Npgsql 1.0.1 驱动程序。

第三方连接器可从数据库软件供应商的网站上获取。

### 批量查询 Batched queries

在结构化查询语言中，批量查询（也称为堆叠查询）是一种向数据库传递多个 SQL 语句的能力，这些语句之间用分号隔开。然后，数据库管理系统将从左到右顺序执行这些语句。尽管这些语句互不相关，但其中一条语句的失败将导致之后的语句无法识别。

下面是一个批量查询的示例：

```sql
SELECT col FROM table1 WHERE id=1; DROP table2
```

批量查询功能是了解本研究的关键一步。

## 堆叠查询注入

通过 SQL 注入测试网络应用程序是否支持批量查询，可以在易受攻击的参数中附加一条 SQL 语句，延迟后端数据库管理系统的响应。这可以通过调用睡眠函数或执行需要时间返回的高性能压力 SELECT 语句来实现，这种技术也被称为重查询 SQL 盲注（“heavy queries blind SQL injection”，此小节可以理解为基于时间的盲注）。

### MySQL

在测试批量查询支持之前，有必要对 DBMS 软件版本进行指纹识别：MySQL 5.0.12 引入了 `SLEEP()`函数，而以前版本的 `BENCHMARK()` 函数（一种重查询 SQL 盲注）可能会被滥用。

### PostgreSQL

在测试是否支持批量查询之前，有必要对 DBMS 软件版本进行指纹识别：PostgreSQL 8.2 引入了`PG_SLEEP()`函数，而在以前的版本中，`generate_series()` 函数（一种重查询盲 SQL 注入）可能会被滥用。

攻击者还可以从操作系统内置 libc 库中创建自定义 `SLEEP()` 函数。

### Microsoft SQL Server

微软 SQL 服务器有一个用于延迟 DBMS 响应的内置语句：`WAITFOR`，其参数 `DELAY` 后跟时间（例如 `WAITFOR DELAY '0:0:5'`）。



